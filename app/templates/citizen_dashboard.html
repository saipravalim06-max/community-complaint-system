{% extends "base.html" %}
{% block content %}

<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
/>

<style>
  body {
    background: linear-gradient(to bottom right, #f8fafc, #e0f2fe);
    font-family: "Inter", sans-serif;
  }

  .dashboard-header {
    background: #fff;
    border-bottom: 1px solid #e5e7eb;
    padding: 1rem 2rem;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  }

  .dashboard-header h1 {
    font-family: "Playfair Display", serif;
    font-weight: 700;
  }

  .summary-card {
    background: #fff;
    border-radius: 12px;
    padding: 1rem 1.5rem;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    text-align: center;
  }

  .summary-card i {
    font-size: 1.5rem;
    margin-bottom: 0.3rem;
  }

  .complaint-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    transition: all 0.2s ease;
  }

  .complaint-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-size: 0.9rem;
    padding: 4px 10px;
    border-radius: 20px;
    font-weight: 500;
    white-space: nowrap; /* ‚úÖ Prevents the emoji/text from splitting */
    flex-shrink: 0;      /* ‚úÖ Keeps it from squishing on smaller widths */
  }
  .status-pending {background: #fff7ed;color: #b45309;}
  .status-inprogress {background: #e0f2fe;color: #0369a1;}
  .status-resolved {background: #dcfce7;color: #166534;}
  .btn-gradient {
    background: linear-gradient(to right, #2563eb, #06b6d4);
    color: white;
    border: none;
  }

  .btn-gradient:hover {
    background: linear-gradient(to right, #1d4ed8, #0891b2);
  }
  .filter-btn {
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .filter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
  }
  .active-filter {
    border: 2px solid #2563eb !important;
    box-shadow: 0 0 10px rgba(37, 99, 235, 0.2);}
    
</style>

<header class="dashboard-header d-flex justify-content-between align-items-center">
  <div>
    <h1 class="h4 mb-1">Citizen Dashboard</h1>
    <p class="text-muted mb-0">Welcome, {{ current_user.username }}</p>
  </div>
  <div>
    <button
      class="btn btn-gradient me-2"
      data-bs-toggle="modal"
      data-bs-target="#newComplaintModal"
    >
      <i class="bi bi-plus-lg me-1"></i> New Complaint
    </button>
    <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-secondary">
      <i class="bi bi-box-arrow-right me-1"></i> Logout
    </a>
  </div>
</header>

<main class="container py-5">
  <h4 class="fw-bold mb-4">My Complaints</h4>

<!-- Summary cards -->
<div class="row g-4 mb-4 text-center">
  <div class="col-md-3">
    <div class="summary-card filter-btn" data-filter="all">
      <i class="bi bi-file-earmark-text text-primary"></i>
      <h6>Total Complaints</h6>
      <h4 class="fw-bold">{{ total_complaints }}</h4>
    </div>
  </div>
  <div class="col-md-3">
    <div class="summary-card filter-btn" data-filter="pending">
      <i class="bi bi-clock text-warning"></i>
      <h6>Pending</h6>
      <h4 class="fw-bold text-warning">{{ pending_count }}</h4>
    </div>
  </div>
  <div class="col-md-3">
    <div class="summary-card filter-btn" data-filter="in_progress">
      <i class="bi bi-hourglass-split text-info"></i>
      <h6>In Progress</h6>
      <h4 class="fw-bold text-info">{{ in_progress_count }}</h4>
    </div>
  </div>
  <div class="col-md-3">
    <div class="summary-card filter-btn" data-filter="resolved">
      <i class="bi bi-check-circle text-success"></i>
      <h6>Resolved</h6>
      <h4 class="fw-bold text-success">{{ resolved_count }}</h4>
    </div>
  </div>
</div>



  <!-- Complaints list -->
<div id="complaintsContainer" class="row g-4">
  {% for complaint in complaints %}
  <div class="col-md-6 col-lg-4 complaint-item" data-status="{{ complaint.status }}">
    <div
      class="card complaint-card p-3"
      data-title="{{ complaint.title }}"
      data-description="{{ complaint.description }}"
      data-address="{{ complaint.address }}"
      data-status="{{ complaint.status }}"
      data-date="{{ complaint.created_at.strftime('%d/%m/%Y, %I:%M %p') }}"
      data-departments="{% for dept in complaint.departments %}{{ dept.name }}{% if not loop.last %}, {% endif %}{% endfor %}"
      data-images="{{ complaint.image_filenames or '' }}"
      data-resolution_note="{{ complaint.resolution_note or '' }}"
      data-resolved_images="{{ complaint.resolved_images or '' }}"
    >
      <div class="d-flex justify-content-between align-items-start mb-2">
        <h5 class="fw-semibold">{{ complaint.title }}</h5>
        <span
          class="status-badge {% if complaint.status == 'pending' %}status-pending{% elif complaint.status == 'in_progress' %}status-inprogress{% else %}status-resolved{% endif %}"
        >
          {% if complaint.status == 'pending' %}üïí Pending{% elif complaint.status == 'in_progress' %}üîÑ In Progress{% else %}‚úÖ Resolved{% endif %}
        </span>
      </div>
      <p class="text-muted small mb-2">{{ complaint.description[:60] }}...</p>
      <p class="text-secondary small mb-1">
        <i class="bi bi-geo-alt me-1"></i>{{ complaint.address }}
      </p>
      <p class="text-secondary small">
        <i class="bi bi-calendar me-1"></i>{{ complaint.created_at.strftime('%d/%m/%Y') }}
      </p>
    </div>
  </div>
  {% else %}
  <div class="text-center mt-5">
    <i class="bi bi-clipboard-x fs-1 text-secondary"></i>
    <p class="text-muted mt-2">No complaints yet. Submit your first one!</p>
    <button
      class="btn btn-gradient"
      data-bs-toggle="modal"
      data-bs-target="#newComplaintModal"
    >
      <i class="bi bi-plus-lg me-1"></i> Submit Complaint
    </button>
  </div>
  {% endfor %}
</div>

</main>

<!-- New Complaint Modal -->
<div
  class="modal fade"
  id="newComplaintModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 rounded-4 shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">Submit New Complaint</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form action="{{ url_for('citizen.dashboard') }}" method="POST" enctype="multipart/form-data">
          {{ form.hidden_tag() }}

          <div class="mb-3">
            {{ form.title.label(class="form-label") }}
            {{ form.title(class="form-control", placeholder="Brief description of the issue") }}
          </div>

          <div class="mb-3">
            {{ form.description.label(class="form-label") }}
            {{ form.description(class="form-control", rows="3", placeholder="Provide detailed information") }}
          </div>
<div class="mb-3 position-relative">
  <label for="addressInput" class="form-label">Address *</label>
  <input
    type="text"
    id="addressInput"
    name="address"
    class="form-control"
    placeholder="Enter your address"
    required
  />
  <button type="button" id="useCurrentLocation" class="btn btn-outline-success btn-sm mt-2">
    üìç Use My Current Location
  </button>
  <input type="hidden" id="latitude" name="latitude">
  <input type="hidden" id="longitude" name="longitude">
</div>

          <div class="mb-3">
            <label class="form-label">Department *</label>
            <div class="d-flex flex-wrap gap-3">
                {% for dept in departments %}
                <div class="form-check">
                    <input
                    class="form-check-input"
                    type="checkbox"
                    name="departments"
                    value="{{ dept.id }}"
                    id="dept_{{ dept.id }}"/>
                    <label class="form-check-label" for="dept_{{ dept.id }}">{{ dept.name }}</label>
                </div>
                {% endfor %}
            </div>
          </div>
          <div class="mb-3">
            {{ form.images.label(class="form-label") }}
            {{ form.images(class="form-control", multiple=True) }}
          </div>

          <div class="d-flex justify-content-end mt-4">
            <button
              type="button"
              class="btn btn-outline-secondary me-2"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-gradient">Submit Complaint</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<!-- Complaint Detail Modal -->
<div class="modal fade" id="complaintDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 rounded-4 shadow-lg">
      <div class="modal-header bg-light">
        <h4 class="modal-title fw-bold" id="complaintTitle"></h4>
        <span class="badge rounded-pill ms-3" id="complaintStatus"></span>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-4">
        <div class="mb-4">
          <h5 class="fw-semibold text-secondary mb-2">Departments</h5>
          <div id="complaintDepartments"></div>
        </div>

        <div class="mb-4">
          <h5 class="fw-semibold text-secondary mb-2">Description</h5>
          <p id="complaintDescription" class="text-muted"></p>
        </div>

        <div class="mb-4">
          <h5 class="fw-semibold text-secondary mb-2">Address</h5>
          <p id="complaintAddress" class="text-muted"></p>
        </div>

        <div class="mb-4">
          <h5 class="fw-semibold text-secondary mb-2">Complaint Images</h5>
          <div id="complaintImages" class="row g-3"></div>
        </div>

        <div id="resolutionNoteSection" class="mt-3" style="display: none;">
           <h5 class="fw-semibold text-secondary mb-2">Resolution Note:</h5>
           <p id="resolutionNote" class="text-muted"></p>
        </div>
        <!-- Resolved Images -->
         <div id="resolvedImagesSection" class="mt-3" style="display: none;">
          <h6><strong>Resolved Images:</strong></h6>
          <div id="resolvedImages" class="d-flex flex-wrap gap-2"></div>
        </div>

        <p class="text-muted small">
          <i class="bi bi-calendar3 me-1"></i>
          Submitted: <span id="complaintDate"></span>
        </p>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const detailModal = new bootstrap.Modal(document.getElementById("complaintDetailModal"));

  document.querySelectorAll(".complaint-card").forEach(card => {
    card.addEventListener("click", () => {
      document.getElementById("complaintTitle").textContent = card.dataset.title;
      document.getElementById("complaintDescription").textContent = card.dataset.description;
      document.getElementById("complaintAddress").textContent = card.dataset.address;
      document.getElementById("complaintDate").textContent = card.dataset.date;

      // Status badge styling
      const statusEl = document.getElementById("complaintStatus");
      const status = card.dataset.status;
      statusEl.textContent = status.charAt(0).toUpperCase() + status.slice(1);
      statusEl.className = "badge rounded-pill px-3 py-2";
      if (status === "pending") statusEl.classList.add("bg-warning", "text-dark");
      else if (status === "in_progress") statusEl.classList.add("bg-info", "text-white");
      else if (status === "resolved") statusEl.classList.add("bg-success", "text-white");

      // Departments
      document.getElementById("complaintDepartments").innerHTML = card.dataset.departments
        .split(",")
        .map(d => `<span class="badge bg-primary-subtle text-primary me-2">${d}</span>`)
        .join("");

      // Complaint images
      const imagesContainer = document.getElementById("complaintImages");
      imagesContainer.innerHTML = "";
      const images = card.dataset.images ? card.dataset.images.split(",") : [];
      if (images.length > 0) {
        images.forEach(img => {
          const imgElement = document.createElement("div");
          imgElement.classList.add("col-md-4");
          imgElement.innerHTML = `
          <img src="/static/uploads/${img.trim()}" 
           class="img-fluid rounded shadow-sm border" 
           alt="Complaint image" 
          onerror="this.style.display='none';" />`;
          imagesContainer.appendChild(imgElement);
        });
      } else {
        imagesContainer.innerHTML = "<p class='text-muted small'>No images uploaded.</p>";
      }

      // --- Resolution Note & Images ---
const resolutionNoteSection = document.getElementById("resolutionNoteSection");
const resolutionNote = document.getElementById("resolutionNote");
const resolvedImagesSection = document.getElementById("resolvedImagesSection");
const resolvedImagesDiv = document.getElementById("resolvedImages");

// Hide sections by default
resolutionNoteSection.style.display = "none";
resolvedImagesSection.style.display = "none";

// Only show for resolved complaints
if (card.dataset.status === "resolved") {
  // Resolution note
  if (card.dataset.resolution_note && card.dataset.resolution_note.trim() !== "") {
    resolutionNote.textContent = card.dataset.resolution_note;
    resolutionNoteSection.style.display = "block";
  }

  // Resolution images
  const resolvedImgs = card.dataset.resolved_images ? card.dataset.resolved_images.split(",") : [];
  if (resolvedImgs.length > 0 && resolvedImgs[0].trim() !== "") {
    resolvedImagesDiv.innerHTML = "";
    resolvedImgs.forEach(img => {
      const imgEl = document.createElement("img");
      imgEl.src = `/static/uploads/${img.trim()}`;
      imgEl.classList.add("img-fluid", "rounded", "shadow-sm", "border", "me-2", "mb-2");
      imgEl.style.maxHeight = "150px";
      resolvedImagesDiv.appendChild(imgEl);
    });
    resolvedImagesSection.style.display = "block";
  }
}


      detailModal.show();
    });
  });
});
// --- Complaint Filtering Logic ---
document.querySelectorAll(".filter-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const filter = btn.getAttribute("data-filter");
    const cards = document.querySelectorAll(".complaint-card");
    let visibleCount = 0;

    cards.forEach(card => {
      const col = card.closest(".col-md-6, .col-lg-4");
      if (!col) return;

      if (filter === "all" || card.dataset.status === filter) {
        col.style.display = "block";
        visibleCount++;
      } else {
        col.style.display = "none";
      }
    });

    // Highlight the active filter button
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active-filter"));
    btn.classList.add("active-filter");

    // üß© Show or hide "No Complaints Found" message
    const existingMsg = document.getElementById("noResultsMessage");
    if (visibleCount === 0) {
      if (!existingMsg) {
        const msg = document.createElement("div");
        msg.id = "noResultsMessage";
        msg.className = "text-center text-muted mt-4";
        msg.innerHTML = "<p>No complaints found.</p>";
        // Append message after the complaint list (row)
        const complaintsRow = document.querySelector(".row.g-4");
        if (complaintsRow) complaintsRow.after(msg);
      }
    } else if (existingMsg) {
      existingMsg.remove();
    }
  });
});

</script>
<!-- ‚úÖ Bootstrap Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- ‚úÖ Load Google Maps JS -->
<script
  src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initAutocomplete"
  async defer
></script>

<script>
function initAutocomplete() {
  console.log("üìç Initializing Autocomplete...");

  const addressInput = document.getElementById("addressInput");
  if (!addressInput) {
    console.error("‚ö†Ô∏è No address input found!");
    return;
  }

  // ‚úÖ Force autocomplete to render outside modal
  const options = {
    fields: ["formatted_address", "geometry"],
    componentRestrictions: { country: "in" },
  };

  const autocomplete = new google.maps.places.Autocomplete(addressInput, options);

  // FIX: Append dropdown to body manually (Bootstrap modal fix)
  const observer = new MutationObserver(() => {
    const pacContainer = document.querySelector('.pac-container');
    if (pacContainer) {
      pacContainer.style.zIndex = "99999";
      document.body.appendChild(pacContainer);
      observer.disconnect();
    }
  });
  observer.observe(document.body, { childList: true, subtree: true });

  // ‚úÖ Capture lat/lng on select
  autocomplete.addListener("place_changed", () => {
    const place = autocomplete.getPlace();
    if (!place.geometry) {
      console.warn("‚ö†Ô∏è No geometry found for place.");
      return;
    }

    const lat = place.geometry.location.lat();
    const lng = place.geometry.location.lng();
    document.getElementById("latitude").value = lat;
    document.getElementById("longitude").value = lng;

    console.log(`‚úÖ Selected: ${place.formatted_address}`);
    console.log(`üåç Coords: ${lat}, ${lng}`);
  });

  console.log("‚úÖ Autocomplete initialized!");
}
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const locationBtn = document.getElementById("useCurrentLocation");
  const addressInput = document.getElementById("addressInput");
  const latInput = document.getElementById("latitude");
  const lngInput = document.getElementById("longitude");

  if (!locationBtn) return;

  locationBtn.addEventListener("click", async () => {
    if (!navigator.geolocation) {
      alert("‚ùå Geolocation is not supported by your browser.");
      return;
    }

    locationBtn.textContent = "‚è≥ Fetching location...";
    locationBtn.disabled = true;

    navigator.geolocation.getCurrentPosition(
      async (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        latInput.value = lat;
        lngInput.value = lng;

        console.log(`‚úÖ Current location: ${lat}, ${lng}`);

        try {
          // Reverse geocode using Google Maps API
          const response = await fetch(
            `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key={{ config.GOOGLE_MAPS_API_KEY }}`
          );
          const data = await response.json();

          if (data.status === "OK" && data.results[0]) {
            addressInput.value = data.results[0].formatted_address;
          } else {
            addressInput.value = "Unknown location";
          }
        } catch (error) {
          console.error("‚ö†Ô∏è Reverse geocode failed:", error);
          addressInput.value = "Location found but unable to fetch address.";
        }

        locationBtn.textContent = "üìç Use My Current Location";
        locationBtn.disabled = false;
      },
      (error) => {
        alert("‚ö†Ô∏è Could not get your location. Please allow access and try again.");
        locationBtn.textContent = "üìç Use My Current Location";
        locationBtn.disabled = false;
      }
    );
  });
});
</script>


{% endblock %}
